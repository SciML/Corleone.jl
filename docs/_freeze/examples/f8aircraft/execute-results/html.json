{
  "hash": "2bf1768ee655667a64d16a0fb5ace6bc",
  "result": {
    "engine": "julia",
    "markdown": "---\ntitle: F8 Aircraft\nauthor: Carl Julius Martensen\ndate: last-modified\ncategories: \n  - ODE\n  - Aeronautics\ndescription: This example introduces Corleone.\nengines: ['julia']\njulia:\n  exeflags: [\"--project=..\"]\nformat: \n  html: default\n  ipynb: default\n---\n\n::: {#2 .cell execution_count=1}\n``` {.julia .cell-code}\nusing Corleone\nusing Corleone.ModelingToolkit\nusing Corleone.ModelingToolkit: t_nounits as t, D_nounits as D\nusing CairoMakie\n```\n:::\n\n\n\n::: {#4 .cell execution_count=1}\n``` {.julia .cell-code}\nfunction F8(; name::Symbol, kwargs...) \n    vars = @variables begin\n        x₁(..)=0.4655, [description = \"Angle of attack\", tunable = false]\n        x₂(..)=0., [description = \"Pitch angle\", tunable = false]\n        x₃(..)=0., [description = \"Pitch rate\", tunable = false]\n        y₁(t)=0.0, [description = \"Algebraic state\"]\n        y₂(t)=0.0, [description = \"Algebraic state\"]\n        v(t)=0., [description = \"Control\", input = true, bounds = (-0.05236, 0.05236)]\n    end \n    \n    x = [x₁(t), x₂(t), x₃(t)]\n    y = [y₁, y₂]\n    \n    ps = @parameters begin \n        T=8.0, [description = \"Time scale\", bounds = (1., 10.)]\n    end\n    \n    eqs = [\n        D(x[1]) ~ T*(y[1]*x[1] + x[3] - 0.0019 * x[2]^2 - 0.215*v + 0.63*v^3)\n        D(x[2]) ~ T*x[3]\n        D(x[3]) ~ T*(-4.208*x[1] - 0.396*x[3]-0.47*x[1]^2-3.564*x[1]^3 - 20.967*v + 6.265*x[1]*y[2] + 46.0*y[2] * v + 61.4 * v^3)\n        0 ~ -y[2] + x[1]*v\n        0 ~ -y[1] - 0.877 - 0.088*x[3] + 0.47*x[1] - x[1]*x[3] + 3.846* x[1]^2 + 0.28*y[2] + 0.47*v^2\n    ] \n    \n    cons = [x₁(1.0), x₂(1.0), x₃(1.0)] .~ 0\n    \n\n    sys = ODESystem(eqs, t; name = name, \n        costs = [T], \n        constraints = cons, \n        consolidate = (x...) -> first(x)[1]\n    )\nend;\n```\n:::\n\n\n\n::: {#6 .cell execution_count=1}\n``` {.julia .cell-code}\naircraft = F8(; name = :Aircraft);\n```\n:::\n\n\n\n::: {#8 .cell execution_count=1}\n``` {.julia .cell-code}\nu = ModelingToolkit.getvar(aircraft, :v, namespace = false)\ncontrol = DirectControlCallback(Num(u) => (; timepoints = collect(0.0:0.05:0.95)))\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n```\nDirectControlCallback{Tuple{@NamedTuple{variable::SymbolicUtils.BasicSymbolic{SymbolicUtils.FnType{Tuple{Any}, Real}}, differential::Bool, bounds::Tuple{Float64, Float64}, independent_variable::SymbolicUtils.BasicSymbolic{Real}, timepoints::Vector{Float64}, defaults::Vector{Float64}}}}(((variable = v, differential = false, bounds = (-0.05236, 0.05236), independent_variable = t, timepoints = [0.0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95], defaults = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]),))\n```\n:::\n:::\n\n\n\n::: {#10 .cell execution_count=1}\n``` {.julia .cell-code}\nproblem = OCProblemBuilder(aircraft, control, ShootingGrid([0.,]));\nexpandedproblem = problem()\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n```\nmin T\n\ns.t.\n\nDynamics Aircraft\n     Differential(t)(x₃(t)) ~ T*(-20.967v(t) - 4.208x₁(t) - 0.396x₃(t) + 46.0v(t)*y₂(t) - 0.47(x₁(t)^2) + 6.265x₁(t)*y₂(t) + 61.4(v(t)^3) - 3.564(x₁(t)^3))\n     Differential(t)(x₂(t)) ~ T*x₃(t)\n     Differential(t)(x₁(t)) ~ T*(-0.215v(t) + x₃(t) + x₁(t)*y₁(t) - 0.0019(x₂(t)^2) + 0.63(v(t)^3))\n     Differential(t)(v(t)) ~ -0.0\nObserved Aircraft\n     y₂(t) ~ v(t)*x₁(t)\n     y₁(t) ~ -0.877 + 0.47x₁(t) - 0.088x₃(t) + 0.28y₂(t) + 0.47(v(t)^2) + 3.846(x₁(t)^2) - x₁(t)*x₃(t)\nConstraints\n     x₁(1.0) ~ 0\n     x₂(1.0) ~ 0\n     x₃(1.0) ~ 0\n```\n:::\n:::\n\n\n\n::: {#12 .cell execution_count=1}\n``` {.julia .cell-code}\nusing Optimization, OptimizationMOI, Ipopt\nusing OrdinaryDiffEqTsit5, SciMLSensitivity\n```\n:::\n\n\n\n::: {#14 .cell execution_count=1}\n``` {.julia .cell-code}\noptimization_problem = OptimizationProblem{true}(expandedproblem, AutoForwardDiff(), Tsit5())\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span style=\"color:rgb(86,182,194)\">OptimizationProblem</span>. In-place: <span style=\"color:rgb(86,182,194)\">true</span>\nu0: 24-element Vector{Float64}:\n 0.4655\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n ⋮\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 0.0\n 8.0</pre>\n```\n:::\n\n:::\n:::\n\n\n\n::: {#16 .cell execution_count=1}\n``` {.julia .cell-code}\noptimization_solution = solve(optimization_problem, Ipopt.Optimizer(),);\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n******************************************************************************\nThis program contains Ipopt, a library for large-scale nonlinear optimization.\n Ipopt is released as open source code under the Eclipse Public License (EPL).\n         For more information visit https://github.com/coin-or/Ipopt\n******************************************************************************\n\nThis is Ipopt version 3.14.17, running with linear solver MUMPS 5.8.0.\n\nNumber of nonzeros in equality constraint Jacobian...:       63\nNumber of nonzeros in inequality constraint Jacobian.:        0\nNumber of nonzeros in Lagrangian Hessian.............:      231\n\nTotal number of variables............................:       21\n                     variables with only lower bounds:        0\n                variables with lower and upper bounds:       21\n                     variables with only upper bounds:        0\nTotal number of equality constraints.................:        3\nTotal number of inequality constraints...............:        0\n        inequality constraints with only lower bounds:        0\n   inequality constraints with lower and upper bounds:        0\n        inequality constraints with only upper bounds:        0\n\niter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls\n   0  8.0000000e+00 6.56e-01 1.00e+00  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0\n   1  6.3848178e+00 1.65e-01 1.25e+00  -1.0 1.62e+00    -  5.63e-01 1.00e+00f  1\n   2  5.1074693e+00 2.06e-01 3.04e+00  -1.0 4.00e+00    -  5.95e-01 3.19e-01f  1\n   3  6.2058750e+00 1.66e-01 3.08e+01  -1.0 1.21e+00    -  7.94e-01 9.06e-01h  1\n   4  6.9571473e+00 6.53e-02 1.01e+01  -1.0 1.65e+00    -  3.98e-01 4.56e-01h  1\n   5  6.7377916e+00 3.31e-02 1.38e+01  -1.0 4.61e-01    -  9.62e-01 4.76e-01f  1\n   6  6.4688133e+00 3.84e-02 5.10e+00  -1.0 4.99e-01    -  1.00e+00 5.39e-01h  1\n   7  6.8227064e+00 5.39e-03 1.03e+00  -1.0 3.54e-01    -  1.00e+00 1.00e+00f  1\n   8  6.7778211e+00 7.03e-04 7.08e-02  -1.0 4.49e-02    -  1.00e+00 1.00e+00h  1\n   9  6.1870658e+00 4.67e-03 7.72e-01  -2.5 5.91e-01    -  8.63e-01 1.00e+00f  1\niter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls\n  10  6.0277515e+00 1.68e-03 1.23e-01  -2.5 1.59e-01    -  1.00e+00 1.00e+00f  1\n  11  6.0032906e+00 2.87e-04 2.46e-02  -2.5 2.45e-02    -  1.00e+00 1.00e+00h  1\n  12  5.9702386e+00 2.32e-04 6.85e-02  -3.8 3.31e-02    -  9.13e-01 1.00e+00f  1\n  13  5.9676445e+00 3.10e-05 2.03e-03  -3.8 2.98e-03    -  1.00e+00 1.00e+00h  1\n  14  5.9673674e+00 8.24e-07 6.58e-05  -3.8 3.39e-04    -  1.00e+00 1.00e+00h  1\n  15  5.9651715e+00 2.32e-06 3.79e-04  -5.7 2.20e-03    -  9.96e-01 1.00e+00f  1\n  16  5.9651530e+00 4.85e-09 3.86e-07  -5.7 2.79e-05    -  1.00e+00 1.00e+00h  1\n  17  5.9651254e+00 2.19e-10 2.50e-08  -8.6 2.77e-05    -  1.00e+00 1.00e+00h  1\n  18  5.9651253e+00 4.87e-13 1.10e-10  -9.0 2.96e-08    -  1.00e+00 1.00e+00h  1\n\nNumber of Iterations....: 18\n\n                                   (scaled)                 (unscaled)\nObjective...............:   5.9651253383531291e+00    5.9651253383531291e+00\nDual infeasibility......:   1.1036642223153775e-10    1.1036642223153775e-10\nConstraint violation....:   4.8722077485854551e-13    4.8722077485854551e-13\nVariable bound violation:   9.9211184406700070e-09    9.9211184406700070e-09\nComplementarity.........:   9.0909401220107662e-10    9.0909401220107662e-10\nOverall NLP error.......:   9.0909401220107662e-10    9.0909401220107662e-10\n\n\nNumber of objective function evaluations             = 19\nNumber of objective gradient evaluations             = 19\nNumber of equality constraint evaluations            = 19\nNumber of inequality constraint evaluations          = 0\nNumber of equality constraint Jacobian evaluations   = 19\nNumber of inequality constraint Jacobian evaluations = 0\nNumber of Lagrangian Hessian evaluations             = 18\nTotal seconds in IPOPT                               = 30.895\n\nEXIT: Optimal Solution Found.\n```\n:::\n:::\n\n\n\n## Solution \n\n```{{julia}}\n#| code-fold: true\n#| renderings: [light, dark]\n\nusing CairoMakie\n\nfunction result_plot_f8aircraft(problem, u)\n  sol = problem.f.f.predictor(u, saveat = 0.01);\n  # We add the right time scaling here\n  sol[1].t .*= optsol.u[end]\n  f = Figure()\n  ax1 = Axis(f[1,1], ylabel = \"v(t)\")\n  plot!(sol[1], idxs = [:v])\n  ax2 = Axis(f[1,2], ylabel = \"x₁(t)\")\n  plot!(sol[1], idxs = [:x₁])\n  lines!([0., optsol.u[end]], [0., 0.], color = :black, linestyle = :dash)\n  ax3 = Axis(f[2,1], ylabel = \"x₂(t)\", xlabel = \"Time\")\n  plot!(sol[1], idxs = [:x₂])\n  lines!([0., optsol.u[end]], [0., 0.], color = :black, linestyle = :dash)\n  ax4 = Axis(f[2,2], ylabel = \"x₃(t)\", xlabel = \"Time\")\n  plot!(sol[1], idxs = [:x₃])\n  lines!([0., optsol.u[end]], [0., 0.], color = :black, linestyle = :dash)\n  linkxaxes!(ax1, ax2, ax3, ax4)\n  return f\nend\n# We want two outputs for the light and dark rendering. Hence we use display\nupdate_theme!(theme_light());\nf_light = result_plot_f8aircraft(optimization_problem, optimization_solution.u)\ndisplay(f_light)\nupdate_theme!(theme_dark());\nf_dark = result_plot_f8aircraft(optimization_problem, optimization_solution.u)\n```\n\n## Appendix\n\nThis document was rendered using Quarto CLI {{< version >}}.\n\n```{{julia}}\n#| code-fold: true\nusing Pkg\n\nversioninfo()\n\nPkg.status() \n```\n\n",
    "supporting": [
      "f8aircraft_files"
    ],
    "filters": [],
    "includes": {}
  }
}